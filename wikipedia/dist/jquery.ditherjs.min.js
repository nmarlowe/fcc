/*! ditherjs 2014-06-21 */
"use strict";var DitherJS=function(a,b){var c=this;c.opt=b||{},c.opt.step=c.opt.step||1,c.opt.className=c.opt.className||"dither",c.opt.algorithm=c.opt.algorithm||"ordered",c.opt.palette=c.opt.palette||[[0,0,0],[255,0,255],[0,255,255],[255,255,255]],c.opt.monochrome=c.opt.monochrome||!1,this.palette=c.opt.palette,this._refreshDither=function(a){a.src=a.src+"?"+Math.random(),a.onload=function(){var b=Date.now();c._dither(a),console.log("Microtime: ",Date.now()-b)}},this._dither=function(a){var b=this,d=a.clientHeight,e=a.clientWidth;this.colorDistance=function(a,b){return Math.sqrt(Math.pow(a[0]-b[0],2)+Math.pow(a[1]-b[1],2)+Math.pow(a[2]-b[2],2))},this.approximateColor=function(a){var d=c.opt.monochrome?[[0,0,0],[255,255,255]]:c.opt.palette,e=function(a,b,c,d){if(2==c.length)return a(b,d)<=a(b,c[1])?d:c[1];var f=c.slice(1);return d=a(b,d)<=a(b,c[1])?d:c[1],e(a,b,f,d)},f=e(b.colorDistance,a,d,d[0]);return f};this.getContext=function(a){var b=document.createElement("canvas");b.height=a.clientHeight,b.width=a.clientWidth,a.parentNode.replaceChild(b,a),b.className=a.className,b.className=b.className.replace(c.opt.className," ");var d=b.getContext("2d");return d.imageSmoothingEnabled=!1,d},this.orderedDither=function(a){for(var g=f.createImageData(a),h=new Uint8ClampedArray(a.data),i=c.opt.step,j=3,k=new Array([1,9,3,11],[13,5,15,7],[4,12,2,10],[16,8,14,6]),l=0;d>l;l+=i)for(var m=0;e>m;m+=i){var n=4*m+4*l*e,o=n,p=n+1,q=n+2;h[o]+=k[m%4][l%4]*j,h[p]+=k[m%4][l%4]*j,h[q]+=k[m%4][l%4]*j;for(var r=new Array(h[o],h[p],h[q]),s=b.approximateColor(r),t=s[0],u=s[1],v=s[2],w=0;i>w;w++)for(var x=0;i>x;x++){var y=n+4*w+4*e*x;h[y]=t,h[y+1]=u,h[y+2]=v}}return g.data.set(h),g},this.atkinsonDither=function(a){for(var g=f.createImageData(a),h=new Uint8ClampedArray(a.data),i=new Uint8ClampedArray(a.data),j=c.opt.step,k=1/8,l=0;d>l;l+=j)for(var m=0;e>m;m+=j){var n=4*m+4*l*e,o=function(a,b){return 4*a+4*b*e},p=n,q=n+1,r=n+2,s=new Array(h[p],h[q],h[r]),t=b.approximateColor(s),u=[];u[p]=h[p]-t[0],u[q]=h[q]-t[1],u[r]=h[r]-t[2],h[o(m+j,l)+0]+=k*u[p],h[o(m-j,l+j)+0]+=k*u[p],h[o(m,l+j)+0]+=k*u[p],h[o(m+j,l+j)+0]+=k*u[p],h[o(m+2*j,l)+0]+=k*u[p],h[o(m,l+2*j)+0]+=k*u[p],h[o(m+j,l)+1]+=k*u[p],h[o(m-j,l+j)+1]+=k*u[p],h[o(m,l+j)+1]+=k*u[p],h[o(m+j,l+j)+1]+=k*u[p],h[o(m+2*j,l)+1]+=k*u[p],h[o(m,l+2*j)+1]+=k*u[p],h[o(m+j,l)+2]+=k*u[p],h[o(m-j,l+j)+2]+=k*u[p],h[o(m,l+j)+2]+=k*u[p],h[o(m+j,l+j)+2]+=k*u[p],h[o(m+2*j,l)+2]+=k*u[p],h[o(m,l+2*j)+2]+=k*u[p];for(var v=t[0],w=t[1],x=t[2],y=0;j>y;y++)for(var z=0;j>z;z++){var A=n+4*y+4*e*z;i[A]=v,i[A+1]=w,i[A+2]=x}}return g.data.set(i),g},this.errorDiffusionDither=function(a){for(var g=f.createImageData(a),h=new Uint8ClampedArray(a.data),i=new Uint8ClampedArray(a.data),j=c.opt.step,k=1/16,l=(new Array([1,9,3,11],[13,5,15,7],[4,12,2,10],[16,8,14,6]),0);d>l;l+=j)for(var m=0;e>m;m+=j){var n=4*m+4*l*e,o=function(a,b){return 4*a+4*b*e},p=n,q=n+1,r=n+2,s=new Array(h[p],h[q],h[r]),t=b.approximateColor(s),u=[];u[p]=h[p]-t[0],u[q]=h[q]-t[1],u[r]=h[r]-t[2],h[o(m+j,l)]=h[o(m+j,l)]+7*k*u[p],h[o(m-j,l+1)]=h[o(m-1,l+j)]+3*k*u[p],h[o(m,l+j)]=h[o(m,l+j)]+5*k*u[p],h[o(m+j,l+j)]=h[o(m+1,l+j)]+1*k*u[p],h[o(m+j,l)+1]=h[o(m+j,l)+1]+7*k*u[q],h[o(m-j,l+j)+1]=h[o(m-j,l+j)+1]+3*k*u[q],h[o(m,l+j)+1]=h[o(m,l+j)+1]+5*k*u[q],h[o(m+j,l+j)+1]=h[o(m+j,l+j)+1]+1*k*u[q],h[o(m+j,l)+2]=h[o(m+j,l)+2]+7*k*u[r],h[o(m-j,l+j)+2]=h[o(m-j,l+j)+2]+3*k*u[r],h[o(m,l+j)+2]=h[o(m,l+j)+2]+5*k*u[r],h[o(m+j,l+j)+2]=h[o(m+j,l+j)+2]+1*k*u[r];for(var v=t[0],w=t[1],x=t[2],y=0;j>y;y++)for(var z=0;j>z;z++){var A=n+4*y+4*e*z;i[A]=v,i[A+1]=w,i[A+2]=x}}return g.data.set(i),g},this.recolorImage=function(a){var b=c.opt.palette[0],d=c.opt.palette[1];console.log("recoloring");for(var e=0;e<a.data.length;e+=4)a.data[e]=a.data[e]<127?b[0]:d[0],a.data[e+1]=a.data[e+1]<127?b[1]:d[1],a.data[e+2]=a.data[e+2]<127?b[2]:d[2];return a};var f=this.getContext(a);f.drawImage(a,0,0,e,d);var g=f.getImageData(0,0,e,d);if("errorDiffusion"==c.opt.algorithm)var h=b.errorDiffusionDither(g);else if("ordered"==c.opt.algorithm)var h=b.orderedDither(g);else{if("atkinson"!=c.opt.algorithm)throw new Error("Not a valid algorithm");var h=b.atkinsonDither(g)}if(c.opt.monochrome)var h=b.recolorImage(h);f.putImageData(h,0,0)};try{for(var d=document.querySelectorAll(a),e=0;e<d.length;e++)this._refreshDither(d[e])}catch(f){}};"function"==typeof define&&define.amd&&define("ditherjs",function(){return DitherJS}),"object"==typeof module&&module.exports&&(module.exports=DitherJS),function(a){a.fn.ditherJS=function(a){return new DitherJS(this.selector,a),this}}(jQuery);